<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/dirtree-doc.css">
<script type="text/javascript" src="jscripts/libs/agilescJS.js"></script>
<script type="text/javascript" src="jscripts/configure/config.commlibs.js"></script>
<script type="text/javascript">
seajs.use(['./jscripts/control/init.js', './jscripts/control/ddtree.js', './jscripts/control/bpcharts.js', './jscripts/control/dynamic'], function (a, b, c, d) {

    /*
     * URL请求配置
     * */

    var urlIniteral = "http://localhost/directiontree/do.php";  //-- 初始化请求URL
    var urlFirm = "http://localhost/directiontree/respFirm.php"; //-- 点击厂商请求URL
    var urlAgency = "http://localhost/directiontree/respAgency.php";//-- 点击经销商请求URL

    /*
     * 初始化流向数数据
     * */
    $.post(urlIniteral, {month:7}, function (d) {
        /* var data = {month:7, data:[
         {id:0, orgType:0, orgName:"厂商", saleAccount:60, salePer:"89%",spid:},
         {id:1, orgType:1, orgName:"一级商", saleAccount:70, salePer:"89%"},
         {id:2, orgType:2, orgName:"二级商", saleAccount:80, salePer:"89%"}
         ]}*/

        var data = d["data"];
        $('div[node-role=organize]').each(function (index) {
            for (var i in data) {
                if (data[i]["id"] == index) {
                    $(this).data("orgNode", {orgType:data[i]["orgType"], orgName:data[i]["orgName"], saleAccount:data[i]["saleAccount"], salePer:data[i]["salePer"]});
                    $(this).find('b').html(data[i]["orgName"]);
                    $(this).find('ac').html(data[i]["saleAccount"]);
                    $('#' + data[i]["spid"]).find('b').html(data[i]["salePer"]);
                    break;
                }
            }
        })
    }, "json");


    function loadChartsBP(args) {
        $.fancybox(args.domStr);
        c.drawBar(args.dataBar, args.configBar); //-- 加载柱状图
        c.drawPie(args.dataPie, args.configPie);//-- 加载饼状图
    }

    var argsBar = {}, argsPie = {}, argsBP = {};
    /*-- 经销商图表配置参数*/
    argsBP.domStr = '<div id="graphBar" style="width:618px;height: 380px; overflow:hidden;"></div><div id="grapPie" style="width:618px;height: 210px; overflow:hidden;"></div>'
    argsBP.configBar = {divID:"graphBar", sizeWidth:618, sizeHeight:360, legends:[
        [1, "去年"],
        [2, "今年"]
    ], legendShow:true, barColor:[
        {color:'#2D6B96', sort:1},
        {color:'#9CCEF0', sort:2}
    ]};
    argsBP.configPie = {divID:"grapPie", sizeWidth:618, sizeHeight:198, radius:102, posX:156, posY:98, labposX:312, labposY:56, angle:45, ccitemName:"productName"};

    /*-- 厂家图表配置参数*/
    argsPie.domStr = '<div id="grapPie" style="width:602px;height: 320px; overflow:hidden;"></div>';
    argsPie.config = {divID:"grapPie", sizeWidth:602, sizeHeight:320, radius:168, posX:202, posY:0, labposX:418, labposY:56, angle:45, ccitemName:"productName"};


    /*-- 执行厂家点击事件*/
    $('div[orgid=firm]').click(function () {
        var orgType = $(this).data("orgNode").orgType;
        $.post(urlFirm, {month:7, orgType:orgType}, function (d) {
                    var d = arrConvert_RemoveJEl(d, "id");
                    $.fancybox(argsPie.domStr);
                    c.drawPie(d, argsPie.config);
                }, "json"
        )
    })

    /*-- 执行经销商点击事件*/
    $('div[node-role=organize]:not([orgid=firm])').click(function () {
        var orgType = $(this).data("orgNode").orgType;
        $.post(urlAgency, {month:7, orgType:orgType}, function (d) {
                    argsBP.dataPie = d.product;
                    argsBP.dataBar = d.org;
                    loadChartsBP(argsBP);
                }, "json"
        )
    })

    /*
     * 表格操作
     * */

    /*-- 初始化打印厂商产品列表表格*/
    $('#detail').click(function () {
        var url = "do.html"
        var args = {};
        args.month = $('select[name=month]').val();
        args.productCode = $('select[name=product]').val();
        args.start = 1;
        args.limit = 20;

        /*-- 加载表格布局(同步)*/
        $.ajax({
            url:"layoutDataTable.html",
            async:false,
            success:function (d) {
                $.fancybox(d);
            }
        })

        /*-- 初始化表格数据*/
        $.post(url, args, function (data) {
            var data = strToJson(data);
            d.dataTable("json");
        });
    })

    /*-- 点击页码事件*/
    $('#dt-pageNum li').live('click', function () {
        var url = "do.html";
        var args = {};
        args.month = $('select[name=month]').val();
        args.productCode = $('select[name=product]').val();
        args.start = 1;
        args.limit = 20;
        args.start = $(this).data("pageNum");

        /*-- 初始化表格数据*/
        $.post(url, args, function (data) {
            var data = strToJson(data);//-- 转换字符类型为Json
            // console.log(data);
            // $.fancybox('<div id="dynamic" style="width:618px;height: 380px; overflow:hidden;"></div>');
            // d.dataTable("json");
            var aDataSet = [
                ['Trident', 'Internet Explorer 4.0', 'Win 95+', '4', 'X'],
                ['Trident', 'Internet Explorer 5.0', 'Win 95+', '5', 'C'],
                ['Trident', 'Internet Explorer 5.5', 'Win 95+', '5.5', 'A'],
                ['Trident', 'Internet Explorer 6', 'Win 98+', '6', 'A'],
                ['Trident', 'Internet Explorer 7', 'Win XP SP2+', '7', 'A']
            ]
            $('#dt-example').dataTable({

                "sPaginationType":"full_numbers",
                "aaData":aDataSet,
                "aoColumns":[
                    { "sTitle":"Engines" },
                    { "sTitle":"Engine" },
                    { "sTitle":"Browser" },
                    { "sTitle":"Browser" },


                ],
                "bDestroy":true
                //"bRetrieve":true
            });
        });
    })

    /*--DataTable:点击查询事件 */
    $('#dt-btnSeeker').live('click', function () {
        var url = "do.html"
        var args = {};
        args.month = $('select[name=month]').val();
        args.productCode = $('select[name=product]').val();
        args.start = 1;
        args.limit = 20;

        $.post(url, args, function (data) {
            var data = strToJson(data);//-- 转换字符类型为Json
            d.dataTable(data); //-- 加载数据到表格
        })
    })


    /*
     * 字符串装换为json对象
     * */

    function strToJson(str) {
        return  (new Function("return " + str))();
    }


    /*
     * 去除json元素
     * */

    function Batch_RemoveJEl(d, a) {
        /*-- 数据样例
         var d = [
         {id:1, productName:"药品名1", salePer:"35%"},
         {id:2, productName:"药品名2", salePer:"36%"},
         {id:3, productName:"药品名3", salePer:"37%"},
         {id:4, productName:"药品名3", salePer:"37%"}
         ]
         var a = ["id", "salePer"];*/
        for (var i = 0; i <= d.length; i++) {
            for (var item in d[i]) {
                /*-- d[i]={id:1, productName:"药品名1", salePer:"35%"}*/
                for (var j = 0 in a) {
                    if (item == a[j]) {
                        delete d[i][item];
                    }
                }
            }
        }
        return d;
    }


    function arrConvert_RemoveJEl(d, a) {
        /*-- 数据样例*/
        /*var response = [
         {id:1, productName:"药品名1", salePer:"35%"},
         {id:2, productName:"药品名2", salePer:"36%"},
         {id:3, productName:"药品名3", salePer:"37%"}
         ]*/

        for (var i = 0; i <= d.length; i++) {
            for (var item in d[i]) {
                if (item == n) {
                    delete d[i][n];
                }
                break;
            }
        }
        return d;
    }


    /*
     * 初始化数据：7月份
     * */
    var response = {month:7, data:[
        {id:1, orgType:0, orgName:"厂商", saleAccount:60, salePer:"89%"},
        {id:2, orgType:1, orgName:"一级商", saleAccount:60, salePer:"89%"},
        {id:3, orgType:2, orgName:"二级商", saleAccount:60, salePer:"89%"}
    ]}

    /*
     * 药厂产品销售比(饼状图)
     * */
    var response = [
        {id:1, productName:"药品名1", salePer:"35%"},
        {id:2, productName:"药品名2", salePer:"36%"},
        {id:3, productName:"药品名3", salePer:"37%"}
    ]

    /*
     * 药厂产品销售排名(表格)
     * */
    var post = {month:7, productCode:2, start:2, limit:20};
    var response = [
        {productName:"药品名1", salAcount:60, overPer:"15%", chainPer:"30%"},
        {productName:"药品名2", salAcount:70, overPer:"16%", chainPer:"31%"},
        {productName:"药品名3", salAcount:80, overPer:"17%", chainPer:"32%"},
    ];

    /*
     * 销售商销售排行(柱状及饼状图)
     * */

    var post = {month:7, orgType:"4"};
    var response = {product:[
        {productName:"药品名1", salePer:"38%"},
        {productName:"药品名2", salePer:"39%"},
        {productName:"药品名3", salePer:"40%"}
    ], org:[
        {level:1, orgName:"商家名1", saleAccount:55, overAccount:38},
        {level:2, orgName:"商家名2", saleAccount:56, overAccount:39},
        {level:3, orgName:"商家名3", saleAccount:57, overAccount:40}
    ]}

})
;


</script>
<title></title>
</head>
<body>
<div data-role="page">

    <div data-role="header">
        <h1>安捷力流向树报表分析DEMO1.0.1</h1>
    </div>
    <!-- /header -->

    <div data-role="content">

        <div id="paintarea"></div>

        <button data-inline="true" id="detail">查看全部产品</button>

    </div>
    <!-- /content -->

</div>
<!-- /page -->
</body>
</html>